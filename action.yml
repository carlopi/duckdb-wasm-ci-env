inputs:
    script:
        description: 'Script to be passed to the docker image'
        required: true

    emscripten_cache_dir:
        description: 'Emscripten cache directory'
        default: /github/workspace/.emscripten_cache
    yarn_cache_dir:
        description: 'Yarn cache directory'
        default: /github/workspace/.yarn_cache
    ccache_dir:
        description: 'Ccache directory'
        default: /github/workspace/.ccache

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: duckdb/duckdb-wasm-ci-env

runs:
    using: 'composite'
    steps:
        - run: |-
            echo "IMAGE_TAG=$(cat ./TAG)" >> $GITHUB_ENV
          shell: bash

        - run: |-
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          shell: bash

        - run: |-
              docker run --rm \
                  -v ${{ github.workspace }}:/github/workspace/ \
                  -v ${{ inputs.emscripten_cache_dir }}:/mnt/emscripten_cache/ \
                  -v ${{ inputs.yarn_cache_dir }}:/mnt/yarn_cache/ \
                  -v ${{ inputs.ccache_dir }}:/mnt/ccache/ \
                  -e EM_CACHE=/mnt/emscripten_cache \
                  -e YARN_CACHE_FOLDER=/mnt/yarn_cache \
                  -e CCACHE_DIR=/mnt/ccache \
                  -e CCACHE_BASEDIR=/github/workspace \
                  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
                  bash -c "${{ inputs.script }}"
          shell: bash